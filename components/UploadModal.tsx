// @ts-nocheck
import React, { useState, useRef, useEffect, useCallback } from 'react';
import { X, Film, Image as ImageIcon, Loader2, Cloud, Terminal, Link, FileUp, Save, Copy, CheckCircle2, ShieldAlert, Tag, Plus, Trash2, ListFilter, ExternalLink, Sparkles, RefreshCw, Layers, LayoutGrid, FileVideo } from 'lucide-react';
import { Movie, User } from '../types.ts';
import { saveVideoToCloud } from '../services/storageService.ts';

interface UploadModalProps {
  user: User;
  onClose: () => void;
  onUpload: (newMovie: Movie) => void;
  movieToEdit?: Movie | null;
}

const CATEGORY_OPTIONS = [
  'Viral',
  'onlyfans',
  'Insta post',
  'Sci-Fi',
  'Action',
  'Adventure',
  'Comedy',
  'Horror'
];

interface BulkItem {
  id: string;
  file: File;
  thumbnailFile: File | null;
  thumbnailPreview: string | null;
  title: string;
  genre: string;
  status: 'pending' | 'extracting' | 'uploading' | 'success' | 'error';
  progress: number;
}

const UploadModal: React.FC<UploadModalProps> = ({ user, onClose, onUpload, movieToEdit }) => {
  const isEditMode = !!movieToEdit;
  const [uploadMode, setUploadMode] = useState<'single' | 'bulk'>(isEditMode ? 'single' : 'single');
  const [uploadType, setUploadType] = useState<'file' | 'link'>(movieToEdit?.videoUrl?.includes('supabase.co') ? 'file' : 'link');
  
  // Single Upload States
  const [title, setTitle] = useState(movieToEdit?.title || '');
  const [description, setDescription] = useState(movieToEdit?.description || '');
  const [genre, setGenre] = useState(movieToEdit?.genre || 'Viral');
  const [videoFile, setVideoFile] = useState<File | null>(null);
  const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);
  const [thumbnailUrl, setThumbnailUrl] = useState(movieToEdit?.thumbnail || '');
  const [thumbnailPreview, setThumbnailPreview] = useState<string | null>(null);
  const [isGeneratingThumbnail, setIsGeneratingThumbnail] = useState(false);
  const [wasAutoGenerated, setWasAutoGenerated] = useState(false);

  // Bulk Upload States
  const [bulkItems, setBulkItems] = useState<BulkItem[]>([]);
  const [isBatchProcessing, setIsBatchProcessing] = useState(false);

  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [error, setError] = useState<string | null>(null);

  const generateSingleThumbnail = async (file: File): Promise<{file: File, url: string}> => {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.muted = true;
      video.playsInline = true;
      video.crossOrigin = "anonymous";
      
      video.onloadedmetadata = () => { video.currentTime = 0.001; };
      video.onseeked = () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        if (ctx) {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            if (blob) {
              const fileResult = new File([blob], 'thumb.jpg', { type: 'image/jpeg' });
              resolve({ file: fileResult, url: URL.createObjectURL(blob) });
            } else reject();
          }, 'image/jpeg', 0.8);
        } else reject();
      };
      video.onerror = reject;
    });
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    if (uploadMode === 'single') {
      const file = files[0];
      setVideoFile(file);
      setIsGeneratingThumbnail(true);
      try {
        const { file: tFile, url: tUrl } = await generateSingleThumbnail(file);
        setThumbnailFile(tFile);
        setThumbnailPreview(tUrl);
        setWasAutoGenerated(true);
      } catch (err) {
        console.error("Thumbnail capture failed", err);
      } finally {
        setIsGeneratingThumbnail(false);
      }
    } else {
      const newItems: BulkItem[] = files.map(file => ({
        id: Math.random().toString(36).substr(2, 9),
        file,
        thumbnailFile: null,
        thumbnailPreview: null,
        title: file.name.replace(/\.[^/.]+$/, "").replace(/[_-]/g, " "),
        genre: 'Viral',
        status: 'pending',
        progress: 0
      }));
      setBulkItems(prev => [...prev, ...newItems]);
      
      // Auto-extract thumbnails for bulk
      for (const item of newItems) {
        setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, status: 'extracting' } : i));
        try {
          const { file: tFile, url: tUrl } = await generateSingleThumbnail(item.file);
          setBulkItems(prev => prev.map(i => i.id === item.id ? { 
            ...i, 
            thumbnailFile: tFile, 
            thumbnailPreview: tUrl, 
            status: 'pending' 
          } : i));
        } catch (err) {
          setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, status: 'error' } : i));
        }
      }
    }
  };

  const handleBulkUpload = async () => {
    setIsUploading(true);
    setIsBatchProcessing(true);
    setError(null);

    let completedCount = 0;
    const totalItems = bulkItems.length;

    for (const item of bulkItems) {
      if (item.status === 'success') continue;
      
      setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, status: 'uploading' } : i));
      
      try {
        const result = await saveVideoToCloud(
          {
            title: item.title,
            description: `Bulk deployment part of batch series. Filename: ${item.file.name}`,
            genre: item.genre,
            uploaderId: user.id,
            uploaderName: user.name,
            year: new Date().getFullYear(),
            rating: 'NR'
          },
          item.file,
          item.thumbnailFile,
          (prog) => {
            setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, progress: prog } : i));
          }
        );
        
        onUpload(result);
        completedCount++;
        setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, status: 'success', progress: 100 } : i));
        setUploadProgress(Math.round((completedCount / totalItems) * 100));
      } catch (err) {
        console.error(`Bulk upload failed for ${item.title}`, err);
        setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, status: 'error' } : i));
      }
    }

    setIsUploading(false);
    setIsBatchProcessing(false);
    if (completedCount === totalItems) {
      setTimeout(onClose, 1500);
    }
  };

  const handleSingleUpload = async (e: React.FormEvent) => {
    e.preventDefault();
    if (isGeneratingThumbnail) return;
    setIsUploading(true);
    setError(null);

    try {
      const result = await saveVideoToCloud(
        {
          id: movieToEdit?.id,
          title,
          description,
          genre,
          uploaderId: user.id,
          uploaderName: user.name,
          videoUrl: uploadType === 'link' ? undefined : undefined,
          thumbnail: thumbnailUrl, 
          year: movieToEdit?.year || new Date().getFullYear(),
          rating: movieToEdit?.rating || 'NR'
        },
        uploadType === 'file' ? videoFile : null,
        thumbnailFile,
        (p) => setUploadProgress(p)
      );
      onUpload(result);
      onClose();
    } catch (err: any) {
      setError(err.message || 'Deployment failed.');
    } finally {
      setIsUploading(false);
    }
  };

  return (
    <div className="fixed inset-0 z-[150] flex items-center justify-center p-0 md:p-6 bg-black/95 backdrop-blur-xl overflow-y-auto">
      <div className="relative bg-[#121212] w-full max-w-5xl min-h-screen md:min-h-0 md:rounded-[2.5rem] overflow-hidden shadow-[0_0_100px_rgba(229,9,20,0.2)] border border-white/5 animate-in fade-in zoom-in-95 duration-300">
        
        {/* Header with Mode Toggle */}
        <div className="p-6 md:p-10 border-b border-white/5 flex flex-col md:flex-row md:items-center justify-between bg-gradient-to-r from-red-600/5 to-transparent gap-6">
          <div className="flex items-center space-x-4">
            <div className="bg-red-600 p-3 rounded-2xl shadow-lg shadow-red-600/20">
              {isEditMode ? <RefreshCw className="w-6 h-6 text-white" /> : <FileUp className="w-6 h-6 text-white" />}
            </div>
            <div>
              <h2 className="text-xl md:text-3xl font-black text-white uppercase italic tracking-tighter">
                {isEditMode ? 'Modify Signal' : 'Signal Deployment'}
              </h2>
              <p className="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em]">Channel: {user.name}</p>
            </div>
          </div>

          {!isEditMode && (
            <div className="flex bg-white/5 p-1 rounded-2xl border border-white/10 self-start md:self-center">
              <button 
                onClick={() => setUploadMode('single')}
                className={`flex items-center space-x-2 px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${uploadMode === 'single' ? 'bg-white text-black shadow-lg' : 'text-gray-500 hover:text-white'}`}
              >
                <LayoutGrid className="w-3.5 h-3.5" />
                <span>Single</span>
              </button>
              <button 
                onClick={() => setUploadMode('bulk')}
                className={`flex items-center space-x-2 px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${uploadMode === 'bulk' ? 'bg-white text-black shadow-lg' : 'text-gray-500 hover:text-white'}`}
              >
                <Layers className="w-3.5 h-3.5" />
                <span>Bulk</span>
              </button>
            </div>
          )}

          <button onClick={onClose} className="absolute top-6 right-6 p-3 hover:bg-white/5 rounded-full transition-all active:scale-90 border border-white/5 md:relative md:top-0 md:right-0">
            <X className="w-6 h-6 text-gray-400" />
          </button>
        </div>

        <div className="p-6 md:p-10">
          {error && (
            <div className="mb-8 bg-red-500/10 border border-red-500/20 p-5 rounded-2xl text-red-500 text-xs font-black uppercase tracking-widest flex items-center animate-in slide-in-from-top-2">
              <ShieldAlert className="w-5 h-5 mr-3 shrink-0" />
              {error}
            </div>
          )}

          {uploadMode === 'single' ? (
            <form onSubmit={handleSingleUpload} className="space-y-8">
              <div className="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div className="lg:col-span-7 space-y-6">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] ml-1">Signal Title</label>
                    <div className="relative group">
                      <Terminal className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-red-600 opacity-50 group-focus-within:opacity-100 transition-opacity" />
                      <input 
                        type="text" 
                        value={title}
                        onChange={(e) => setTitle(e.target.value)}
                        className="w-full bg-white/5 border border-white/10 rounded-2xl pl-12 pr-4 py-4 outline-none focus:border-red-600/50 transition text-sm font-bold"
                        placeholder="BROADCAST_NAME"
                        required
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] ml-1">Category</label>
                      <div className="relative">
                        <Tag className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" />
                        <select 
                          value={genre}
                          onChange={(e) => setGenre(e.target.value)}
                          className="w-full bg-[#181818] border border-white/10 rounded-2xl pl-12 pr-4 py-4 outline-none focus:border-red-600/50 transition text-sm font-bold appearance-none cursor-pointer"
                        >
                          {CATEGORY_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] ml-1">Meta Description</label>
                    <textarea 
                      value={description}
                      onChange={(e) => setDescription(e.target.value)}
                      className="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 outline-none focus:border-red-600/50 transition h-40 resize-none text-sm font-medium leading-relaxed"
                      placeholder="Transmission details..."
                    />
                  </div>
                </div>

                <div className="lg:col-span-5 space-y-6">
                  <div className="relative aspect-video rounded-3xl border-2 border-dashed border-white/10 flex flex-col items-center justify-center p-6 text-center hover:border-red-600/40 transition group cursor-pointer bg-white/[0.02]">
                    <input 
                      type="file" 
                      accept="video/*"
                      onChange={handleFileChange}
                      className="absolute inset-0 opacity-0 cursor-pointer z-10"
                    />
                    <Cloud className={`w-12 h-12 mb-4 transition-transform duration-500 ${videoFile ? 'text-green-500 scale-110' : 'text-gray-600 group-hover:scale-110 group-hover:text-red-600'}`} />
                    <p className="text-xs font-black uppercase tracking-widest text-white truncate max-w-full px-4">
                      {videoFile ? videoFile.name : 'Select Data Packet'}
                    </p>
                  </div>

                  <div className="space-y-4">
                    <label className="text-[10px] font-black text-gray-500 uppercase tracking-[0.2em] ml-1">Signal Cover</label>
                    <div className="relative aspect-video rounded-3xl overflow-hidden bg-zinc-900 border border-white/5 group shadow-2xl">
                      {(thumbnailPreview || thumbnailUrl) ? (
                        <img src={thumbnailPreview || thumbnailUrl} alt="Signal Preview" className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                      ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-700">
                          <ImageIcon className="w-10 h-10 mb-2 opacity-20" />
                          <span className="text-[10px] font-black uppercase tracking-[0.3em]">No Visual Signal</span>
                        </div>
                      )}
                      
                      {isGeneratingThumbnail && (
                        <div className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-20">
                          <Loader2 className="w-10 h-10 text-red-600 animate-spin mb-4" />
                          <span className="text-[10px] font-black text-white uppercase tracking-[0.5em] animate-pulse">Capturing Frame...</span>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div className="pt-10 border-t border-white/5">
                <button 
                  type="submit"
                  disabled={isUploading || isGeneratingThumbnail || (!videoFile && !isEditMode)}
                  className="w-full relative overflow-hidden group/btn bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white py-5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.4em] transition-all shadow-[0_20px_40px_rgba(229,9,20,0.3)]"
                >
                  {isUploading ? <Loader2 className="w-6 h-6 animate-spin mx-auto" /> : <span>Initialize Broadcast</span>}
                </button>
              </div>
            </form>
          ) : (
            <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4">
              {/* Bulk Dropzone */}
              {bulkItems.length === 0 ? (
                <div className="relative aspect-[21/9] rounded-[3rem] border-2 border-dashed border-white/10 flex flex-col items-center justify-center p-12 text-center hover:border-red-600/40 transition group cursor-pointer bg-white/[0.02]">
                  <input 
                    type="file" 
                    accept="video/*"
                    multiple
                    onChange={handleFileChange}
                    className="absolute inset-0 opacity-0 cursor-pointer z-10"
                  />
                  <Layers className="w-16 h-16 mb-6 text-gray-600 group-hover:scale-110 group-hover:text-red-600 transition-all duration-500" />
                  <h3 className="text-xl font-black text-white uppercase italic tracking-tight">Mass Broadcast Deployment</h3>
                  <p className="text-xs text-gray-500 font-bold mt-2 uppercase tracking-widest">Drop multiple video signals to queue for transmission</p>
                </div>
              ) : (
                <div className="space-y-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className="bg-red-600/10 px-4 py-2 rounded-full border border-red-600/20">
                        <span className="text-[10px] font-black text-red-600 uppercase tracking-widest">Queue: {bulkItems.length} Signals</span>
                      </div>
                      <button 
                        onClick={() => setBulkItems([])}
                        className="text-[10px] font-black text-gray-500 uppercase hover:text-white transition tracking-widest"
                      >
                        Clear All
                      </button>
                    </div>
                    <button 
                      onClick={() => document.getElementById('bulk-add').click()}
                      className="flex items-center space-x-2 text-[10px] font-black uppercase tracking-widest text-white bg-white/5 hover:bg-white/10 px-6 py-3 rounded-xl border border-white/10 transition"
                    >
                      <Plus className="w-4 h-4" />
                      <span>Add More</span>
                      <input id="bulk-add" type="file" accept="video/*" multiple onChange={handleFileChange} className="hidden" />
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {bulkItems.map((item) => (
                      <div key={item.id} className="bg-white/5 border border-white/10 rounded-3xl p-4 flex items-center space-x-4 group hover:bg-white/[0.08] transition-all relative overflow-hidden">
                        <div className="w-32 aspect-video bg-black rounded-xl overflow-hidden relative shrink-0">
                          {item.thumbnailPreview ? (
                            <img src={item.thumbnailPreview} className="w-full h-full object-cover" alt="" />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center">
                              {item.status === 'extracting' ? <Loader2 className="w-5 h-5 text-red-600 animate-spin" /> : <FileVideo className="w-5 h-5 text-gray-700" />}
                            </div>
                          )}
                          {item.status === 'success' && (
                            <div className="absolute inset-0 bg-green-500/80 flex items-center justify-center backdrop-blur-sm">
                              <CheckCircle2 className="w-8 h-8 text-white" />
                            </div>
                          )}
                        </div>

                        <div className="flex-1 min-w-0 space-y-2">
                          <input 
                            type="text" 
                            value={item.title}
                            onChange={(e) => setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, title: e.target.value } : i))}
                            className="w-full bg-transparent border-none text-xs font-black text-white uppercase tracking-tight outline-none focus:text-red-600 transition truncate"
                          />
                          <div className="flex items-center space-x-3">
                            <select 
                              value={item.genre}
                              onChange={(e) => setBulkItems(prev => prev.map(i => i.id === item.id ? { ...i, genre: e.target.value } : i))}
                              className="bg-black/40 text-[9px] font-black uppercase text-gray-400 rounded-lg px-2 py-1 outline-none border border-white/5"
                            >
                              {CATEGORY_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                            <span className="text-[9px] font-bold text-gray-600 uppercase">{(item.file.size / (1024 * 1024)).toFixed(1)}MB</span>
                          </div>
                          
                          {item.status === 'uploading' && (
                            <div className="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                              <div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${item.progress}%` }} />
                            </div>
                          )}
                        </div>

                        <button 
                          onClick={() => setBulkItems(prev => prev.filter(i => i.id !== item.id))}
                          className="p-2 text-gray-600 hover:text-red-600 transition-colors opacity-0 group-hover:opacity-100"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>

                  <div className="pt-10 border-t border-white/5 flex flex-col space-y-6">
                    {isUploading && (
                      <div className="w-full space-y-3">
                        <div className="flex justify-between items-end">
                          <div className="space-y-1">
                            <span className="text-[10px] font-black uppercase tracking-[0.4em] text-red-600">Batch Transmission Active</span>
                            <p className="text-[9px] text-gray-500 font-bold uppercase">Processing parallel signals...</p>
                          </div>
                          <span className="text-2xl font-black italic text-white">{uploadProgress}%</span>
                        </div>
                        <div className="w-full h-2 bg-white/5 rounded-full overflow-hidden">
                          <div className="h-full bg-red-600 transition-all duration-500" style={{ width: `${uploadProgress}%` }} />
                        </div>
                      </div>
                    )}
                    
                    <button 
                      onClick={handleBulkUpload}
                      disabled={isUploading || bulkItems.length === 0}
                      className="w-full relative overflow-hidden group/btn bg-red-600 hover:bg-red-700 disabled:opacity-50 text-white py-6 rounded-[1.5rem] text-[10px] font-black uppercase tracking-[0.4em] transition-all shadow-[0_40px_80px_rgba(229,9,20,0.3)] active:scale-95"
                    >
                      {isUploading ? (
                        <div className="flex items-center justify-center space-x-3">
                          <Loader2 className="w-5 h-5 animate-spin" />
                          <span>Transmitting Batch...</span>
                        </div>
                      ) : (
                        <span>Initialize Bulk Deployment</span>
                      )}
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default UploadModal;